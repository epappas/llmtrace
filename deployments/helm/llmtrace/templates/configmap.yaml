apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "llmtrace.fullname" . }}-config
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "llmtrace.labels" . | nindent 4 }}
data:
  config.yaml: |
    # Generated by Helm â€” do not edit manually
    listen_addr: {{ .Values.proxy.listenAddr | quote }}
    upstream_url: {{ .Values.proxy.upstreamUrl | quote }}

    storage:
      profile: {{ .Values.proxy.storageProfile | quote }}
      database_path: "/data/llmtrace.db"

    logging:
      level: {{ .Values.proxy.logging.level | quote }}
      format: {{ .Values.proxy.logging.format | quote }}

    timeout_ms: {{ .Values.proxy.timeoutMs }}
    connection_timeout_ms: {{ .Values.proxy.connectionTimeoutMs }}
    max_connections: {{ .Values.proxy.maxConnections }}
    max_request_size_bytes: {{ .Values.proxy.maxRequestSizeBytes }}

    enable_tls: false
    enable_security_analysis: {{ .Values.proxy.enableSecurityAnalysis }}
    enable_trace_storage: {{ .Values.proxy.enableTraceStorage }}
    enable_streaming: {{ .Values.proxy.enableStreaming }}

    security_analysis_timeout_ms: 5000
    trace_storage_timeout_ms: 10000

    rate_limiting:
      enabled: {{ .Values.proxy.rateLimiting.enabled }}
      requests_per_second: {{ .Values.proxy.rateLimiting.requestsPerSecond }}
      burst_size: {{ .Values.proxy.rateLimiting.burstSize }}
      window_seconds: {{ .Values.proxy.rateLimiting.windowSeconds }}

    circuit_breaker:
      enabled: {{ .Values.proxy.circuitBreaker.enabled }}
      failure_threshold: {{ .Values.proxy.circuitBreaker.failureThreshold }}
      recovery_timeout_ms: {{ .Values.proxy.circuitBreaker.recoveryTimeoutMs }}
      half_open_max_calls: {{ .Values.proxy.circuitBreaker.halfOpenMaxCalls }}

    alerts:
      enabled: {{ .Values.proxy.alerts.enabled }}
      webhook_url: {{ .Values.proxy.alerts.webhookUrl | quote }}
      min_severity: {{ .Values.proxy.alerts.minSeverity | quote }}
      min_security_score: {{ .Values.proxy.alerts.minSecurityScore }}
      cooldown_seconds: {{ .Values.proxy.alerts.cooldownSeconds }}

    cost_caps:
      enabled: {{ .Values.proxy.costCaps.enabled }}

    grpc:
      enabled: {{ .Values.proxy.grpc.enabled }}
      listen_addr: {{ .Values.proxy.grpc.listenAddr | quote }}

    health_check:
      enabled: true
      path: "/health"
      interval_seconds: 10
      timeout_ms: 5000
      retries: 3
